---
title: "HPAStainR vs Single Cell Data"
author: "Tim Nieuwenhuis"
date: "5/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(HPAStainR)
```


### Load HPA data
```{r}

hpa_dat <- read.table("../normal_tissue.tsv", sep = '\t', header = TRUE, stringsAsFactors = F)

```



### Read in PanglaoDB
```{r read in pangloa data}
dat <- read.table("PanglaoDB_markers_27_Mar_2020.tsv", sep = "\t", header = T, stringsAsFactors = F)

#See data organization
head(dat)

#Remove mouse data, product description, and nickname column
dat <- dat %>% select(-ends_with("mouse"), -nicknames, -product.description) %>%
  #protein coding only and mouse exclusive
  filter(species != "Mm",gene.type == "protein-coding gene" | gene.type == "protein coding gene") %>%
  #Make data more easily jive with hpastainr such as lungs vs lung
  mutate(organ = ifelse(organ == "Lungs", "Lung", organ),
         organ = ifelse(organ == "Heart", "Heart Muscle", organ)) %>%
  #make comprable column to hpastainr
  mutate(stainr_col = paste0(toupper(organ), " ", tolower(cell.type)))



```

## The for loop that runs PanglaoDB through HPAStainR
```{r }

#Get a list of panglao cell types
groupings <- unique(dat$stainr_col)

#This is used if trouble shooting
#cell_type <- groupings[1]

#Initiate df that will be added to via the loop
final_df <- NULL
#Use this to catch dropped cell types without staining
no_stain <- NULL

#For loop through panglao cell types to run them through HPAStainR
for (cell_type in groupings) {
  
  #Subset out data to just cell type of interest
  sub_dat <- dat %>% filter(stainr_col == cell_type)
  #Pull out the list of genes
  genes <- sub_dat$official.gene.symbol
  #Run HPAStainR
  stain_result <- HPAStainR(gene_list = genes,hpa_dat = hpa_dat, cancer_analysis = "normal", csv_names = T)
  
  stain_result
  
  if (is.na(stain_result[1,2])) {
    no_stain <- c(no_stain, cell_type)
    next
  }
  
  #Make a filter to get top stainr result from a tissue
  stain_result  <- stain_result %>%
    mutate(tissue = str_sub(cell_type, start = 1, end = (str_locate(cell_type,"-"))[,1]  -2),
           stained_count = str_count(detected_proteins,",") + 1)
  
  #Top results of HPAStainR
  top_result <- stain_result$cell_type[1]
  top_stain <- stain_result$staining_score[1]
  top_pval <- stain_result$p_val[1]
  top_adj_pval <- stain_result$p_val_adj[1]

  ##Below code is used to match tissue types from panglao and HPA and then pull
  #the topped matched hit
  
  #normal
  sub_stain <- stain_result %>% filter(tissue == toupper(unique(sub_dat$organ)))
  
  
  if (is.na(unique(sub_dat$organ))) {
    sub_dat$organ <- ""
  }
  
  #GI tract
  if ("GI TRACT" == toupper(unique(sub_dat$organ))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("COLON", "DUODENUM", "RECTUM", "SMALL INTESTINE"))
  }
  
  #Blood brain barrier
  if ("BRAIN" == toupper(unique(sub_dat$organ)) |
      "endothelial cells (blood brain barrier)" == tolower(unique(sub_dat$cell.type))) {
    #Brain
    sub_stain <- stain_result %>% filter(tissue %in% c("CAUDATE",
                                                       "CEREBELLUM",
                                                       "CEREBRAL CORTEX",
                                                       "CHOROID PLEXUS",
                                                       "DORSAL RAPHE",
                                                       "HIPPOCAMPUS",
                                                       "HYPOTHALAMUS",
                                                       "PITUITARY GLAND",
                                                       "SUBSTANTIA NIGRA"))
    }
  #Eye
      if ("EYE" == toupper(unique(sub_dat$organ))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("RETINA"))
      }
  #Breast
   if ("MAMMARY GLAND" == toupper(unique(sub_dat$organ))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("BREAST",
                                                       "LACTATING BREAST"))
    }
  
    #reproductive
   if ("REPRODUCTIVE" == toupper(unique(sub_dat$organ))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("TESTIS",
                                                       "OVARY"))
   }
      #adrenal
   if ("ADRENAL GLANDS" == toupper(unique(sub_dat$organ))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("ADRENAL GLAND"))
   }
  
        #throid
   if ("THYROID" == toupper(unique(sub_dat$organ))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("THYROID GLAND"))
   }
  
          #ENDOTHELIAL
   if ("endothelial cells (aorta)" == tolower(unique(sub_dat$cell.type))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("COLON"))
    }
  
  
        #bone and blood
   if ("BONE" == toupper(unique(sub_dat$organ)) | "BLOOD" == toupper(unique(sub_dat$organ))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("BONE MARROW"))
   }
  
     if ("OLFACTORY SYSTEM" == toupper(unique(sub_dat$organ))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("NASOPHARYNX"))
     }
  
       if ("IMMUNE SYSTEM" == toupper(unique(sub_dat$organ))) {
    
    sub_stain <- stain_result %>% filter(tissue %in% c("BONE MARROW",
                                                       "THYMUS",
                                                       "LYMPH NODE",
                                                       "TONSIL"))
    }
  
  
   if ("CONNECTIVE TISSUE" == toupper(unique(sub_dat$organ))) {
    #Brain
    sub_stain <- stain_result %>% filter(tissue %in% c("ADIPOSE TISSUE",
                                                       "SOFT TISSUE"))
    }
  
  #Stores the top result from the correct tissue in an object
  top_tiss_result <- sub_stain$cell_type[1]
  top_tiss_stain <- sub_stain$staining_score[1]
  top_tiss_pval <- sub_stain$p_val[1]
  top_tiss_adj_pval <- sub_stain$p_val_adj[1]
  
  #Catches no found tissues
  if (nrow(sub_stain) == 0) {
    top_tiss_result <- "tissue not found"
  }
  
  #Number of proteins used
  proteins_used <- length(unique(sub_dat$official.gene.symbol))
  
  #The average N of proteins used for the top ten results (not all tissues are tested equally)
  top_10_avg_prot_tested <- mean(head(stain_result$number_of_proteins))
  
  #Make confidence score to account for low protein count not being taken into account
  
  conf_score <- ifelse(proteins_used > 50, 50, proteins_used) * 0.02 * top_stain
  
  #If there is not enough data to run a chi_square turn results into NA
  if (is.null(top_adj_pval)) {
    top_adj_pval =NA 
    top_tiss_adj_pval =NA
     top_pval =NA 
    top_tiss_pval =NA
  }
  
  #Make single row output dataframe to be bound to main dataframe
  temp_dat <- data.frame(cell_type,
                         conf_score,
                         proteins_used,
                         top_10_avg_prot_tested,
                         top_result, top_stain,
                         top_pval,
                         top_adj_pval,
                         top_tiss_result,
                         top_tiss_stain,
                         top_tiss_pval,
                         top_tiss_adj_pval,
                         stringsAsFactors = F)
  
  #Biind it
  final_df <- rbind(final_df, temp_dat)
}

head(final_df)
write.csv(final_df, "supplemental_table_1_final_df_output.csv", row.names = F)
```

## PanglaoDB Data summary
### Includes unused csv and supplemental figure 1
```{r}

#Comparing available cell types between Panglao and HPA
avail_hpa_tissue_cells = unique(stain_result$cell_type)
avail_pangloa_tissue_cells = unique(dat$stainr_col)

avail_hpa_tissue_cells <- c(avail_hpa_tissue_cells,
                            rep("", length(avail_pangloa_tissue_cells) - length(avail_hpa_tissue_cells)))

tissues_and_cells <- cbind(avail_hpa_tissue_cells, avail_pangloa_tissue_cells)

colnames(tissues_and_cells) <- c("Tissue - Cells in HPA", " Tissue - Cells in PanglaoDB")

write.csv(tissues_and_cells, "panglao_v_hpa_available_cell_types.csv", row.names = F)


#Make a histogram of how many marker genes there are per cell type
summ_dat <- dat %>% group_by(cell.type) %>% summarize(genes = n())

ggplot(summ_dat, aes(x=genes)) + 
  geom_histogram(color="black", fill="white") +
  xlab("Marker Genes Per Cell Type") + 
  labs(title ="PanglaoDB Markers per cell type",
       subtitle =  paste("N = ", nrow(summ_dat)))

ggsave("supplemental_figure_1_pangloa_hist.png")

```

## HPA Data Summary
### Includes Supplemental Figure 2-4 and Supplemental Table 4
```{r}


#Generate data to gain an understanding of the amount of proteins tested to the amount of proteins stained

#Clean the hpa data
hpa_dat_new <- hpa_dat %>% 
      mutate(Tissue = gsub('[[:digit:]]+', '', Tissue),
             tissue_cell = paste0(toupper(str_trim(Tissue))," - ", Cell.type)) %>%
      distinct()


#Generate a summary of hpa_summary
hpa_dat_sum <- hpa_dat_new %>% group_by(tissue_cell) %>%
  summarise(proteins = n(), detected = sum(!(Level %in% "Not detected")) ) %>%
  mutate(det_o_test = detected/proteins,
         amount_tested = ifelse(proteins <= 50, "less than or equal to 50", 
                          ifelse(proteins > 50 & proteins <= 700, "between 51-700",
                          ifelse(proteins > 700 & proteins <= 15000, "between 701-15,000",
                                   "greater than 15,000")))) %>%
    filter(tissue_cell != "N/A - N/A")


ggplot(hpa_dat_sum, aes(x=(proteins))) + 
  geom_histogram(color="black", fill="white", bins=100) +
  xlab("Tested Proteins Per Cell Type") +
  labs( title ="Human Protein Atlas Count of Tested Proteins per Cell Type",
        subtitle = paste("N = ", nrow(hpa_dat_sum),"; 100 bins")) +
  geom_vline(xintercept= c(50,700, 15000),
             linetype = c("longdash"),
             color = c("blue","red", "dark green"),
             size = 1.2) +
  geom_segment(aes(x = c(5000),
                   xend = c(10000),
                   y = c(20),
                   yend = c(20)),
               color = "blue",
               linetype = c("longdash"),
               size = 1.2) +
  geom_segment(aes(x = c(5000),
                   xend = c(10000),
                   y = c(30),
                   yend = c(30)),
               color = "red",
               linetype = c("longdash"), size = 1.2) +
  geom_segment(aes(x = c(5000),
                   xend = c(10000),
                   y = c(40),
                   yend = c(40)),
               color = "dark green",
               linetype = c("longdash"),
               size = 1.2) +
  annotate(geom="text", #angle = 90, vjust = 1.3,
           size = 5,  
           x=c(7500, 7500, 7500), 
           y=c(25, 35, 45), 
           label=c("50 Protein Line", "700 Protein Line", "15000 Protein Line")
              #color="red"
          
           )

ggsave("supplemental_figure_2_proteins_tested.png")

ggplot(hpa_dat_sum, aes(x=detected)) + 
  geom_histogram(aes(fill =amount_tested),color="black", bins=50) +
  xlab("Detected Proteins Per Cell Type") +
  labs(title="HPA detected proteins",
  subtitle =paste("N = ", nrow(hpa_dat_sum)))

ggsave("supplemental_figure_3_proteins_detected.png")


ggplot(hpa_dat_sum, aes(x=det_o_test)) + 
  geom_histogram(aes(fill =amount_tested), color="black") +
  xlab("Detected/Tested Proteins Per Cell Type") +
  labs(title="HPA detected/tested proteins",
       subtitle =paste("N = ", nrow(hpa_dat_sum)))

ggsave("supplemental_figure_4_proteins_detected_divby_tested.png")


hpa_dat_sum_out <- select(hpa_dat_sum,
                          `Cell Type` = tissue_cell,
                          `Tested Proteins` = proteins,
                          `Detected Proteins` = detected,
                          `Detected Tested Ratio` = det_o_test)

write.csv(hpa_dat_sum_out, "supplemental_table_4_hpa_cell_type_tested_ratio.csv",row.names = F)

```


